{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Console | TrisSEAS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/gate_console.css' %}">
</head>
<body>
    <header class="topbar">
        <div class="brand">TrisSEAS Console</div>
        <div class="links">
            <a href="/">Home</a>
            <a href="/admin/panel/">Admin panel</a>
            <a href="/admin/">Django admin</a>
        </div>
    </header>

    <main class="layout">
        <section class="panel">
            <div class="panel-heading">
                <div>
                    <p class="eyebrow">Live capture</p>
                    <h1>Use your laptop webcam</h1>
                    <p class="lede">Start the camera, capture a frame, and simulate the Entry Gate flow entirely in your browser. You can enroll a student or perform a gate scan without any servers.</p>
                </div>
                <div class="chip">RFID-ready</div>
            </div>

            <div class="video-grid">
                <div class="video-card">
                    <div class="video-frame">
                        <video id="camera" autoplay playsinline></video>
                        <canvas id="snapshot" class="hidden"></canvas>
                        <div id="videoOverlay" class="overlay hidden">Camera offline</div>
                    </div>
                    <div class="controls">
                        <button id="startCamera" class="btn primary">Start camera</button>
                        <button id="stopCamera" class="btn ghost" disabled>Stop camera</button>
                        <button id="capture" class="btn" disabled>Capture frame</button>
                    </div>
                    <div class="meta-grid">
                        <div>
                            <p class="muted">Last capture</p>
                            <p id="metaCaptured">—</p>
                        </div>
                        <div>
                            <p class="muted">Resolution</p>
                            <p id="metaResolution">—</p>
                        </div>
                    </div>
                </div>

                <div class="form-card">
                    <div class="field">
                        <label for="action">Action</label>
                        <select id="action">
                            <option value="entry">Entry</option>
                            <option value="exit">Exit</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="studentId">Student ID (for enrollment)</label>
                        <input type="text" id="studentId" placeholder="e.g., STU-2024-001">
                        <p class="help">When scanning, the face match drives the student lookup. Provide the ID only when enrolling.</p>
                    </div>
                    <div class="actions">
                        <button id="enroll" class="btn primary" disabled>Enroll face</button>
                        <button id="scan" class="btn" disabled>Run scan</button>
                    </div>
                    <div class="status" id="status">Waiting to start camera…</div>
                </div>

                <aside class="session">
                    <div class="session-head">
                        <p class="eyebrow">Session log</p>
                        <button id="clearLog" class="btn ghost" type="button">Clear</button>
                    </div>
                    <div class="log" id="log"></div>
                </aside>
            </div>
        </section>

        <section class="panel">
            <div class="panel-heading">
                <div>
                    <p class="eyebrow">Hardware bridge</p>
                    <h2>RFID scanner integration</h2>
                    <p class="lede">Plug in your USB RFID reader alongside the webcam. Most readers emulate a keyboard: tap a card to autofill the RFID field on the Student admin page.</p>
                </div>
            </div>
            <div class="rfid-grid">
                <div class="card">
                    <h3>Admin workflow</h3>
                    <ol>
                        <li>Open <a href="/admin/" target="_blank" rel="noreferrer">Admin » Students</a>.</li>
                        <li>Click a student and place the cursor in the <strong>RFID tag</strong> box.</li>
                        <li>Present the card to your scanner; the value is captured instantly.</li>
                    </ol>
                </div>
                <div class="card">
                    <h3>Tips</h3>
                    <ul>
                        <li>Keep the webcam running while you test RFID so you can validate full gate events.</li>
                        <li>Use the <em>Run scan</em> button to generate Gate Events in real time.</li>
                        <li>If your scanner requires drivers, install them before opening this page.</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <script>
        const camera = document.getElementById('camera');
        const snapshot = document.getElementById('snapshot');
        const overlay = document.getElementById('videoOverlay');
        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const captureBtn = document.getElementById('capture');
        const enrollBtn = document.getElementById('enroll');
        const scanBtn = document.getElementById('scan');
        const statusBox = document.getElementById('status');
        const studentIdInput = document.getElementById('studentId');
        const actionSelect = document.getElementById('action');
        const metaCaptured = document.getElementById('metaCaptured');
        const metaResolution = document.getElementById('metaResolution');
        const logContainer = document.getElementById('log');
        const clearLogBtn = document.getElementById('clearLog');

        let stream;
        let lastBlob;
        let lastCaptureSummary;
        const enrollmentStoreKey = 'trisseas-local-enrollments';
        const sessionLog = [];

        const localEnrollments = (() => {
            try {
                const saved = localStorage.getItem(enrollmentStoreKey);
                if (!saved) return new Map();
                return new Map(JSON.parse(saved));
            } catch (error) {
                console.warn('Unable to restore enrollments', error);
                return new Map();
            }
        })();

        function persistEnrollments() {
            try {
                localStorage.setItem(enrollmentStoreKey, JSON.stringify([...localEnrollments]));
            } catch (error) {
                console.warn('Unable to persist enrollments', error);
            }
        }

        function setStatus(message, tone = 'info') {
            statusBox.textContent = message;
            statusBox.dataset.tone = tone;
        }

        function addLog(message, tone = 'info') {
            const row = document.createElement('div');
            row.className = `log-row ${tone}`;
            row.textContent = message;
            logContainer.prepend(row);
            sessionLog.unshift({ message, tone, at: new Date() });
        }

        function renderCaptureMeta(summary) {
            if (!summary) return;
            metaCaptured.textContent = new Date(summary.capturedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            metaResolution.textContent = summary.resolution;
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                camera.srcObject = stream;
                camera.classList.remove('hidden');
                overlay.classList.add('hidden');
                captureBtn.disabled = false;
                stopCameraBtn.disabled = false;
                startCameraBtn.disabled = true;
                setStatus('Camera ready. Capture a frame to enroll or scan locally.', 'success');
                addLog('Camera started', 'success');
            } catch (error) {
                console.error(error);
                setStatus('Unable to access webcam. Please allow camera permissions.', 'error');
                addLog('Camera blocked by browser', 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            camera.srcObject = null;
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            captureBtn.disabled = true;
            enrollBtn.disabled = true;
            scanBtn.disabled = true;
            overlay.classList.remove('hidden');
            setStatus('Camera stopped.', 'info');
            addLog('Camera stopped', 'info');
        }

        function captureFrame() {
            if (!stream) {
                setStatus('Start the camera first.', 'error');
                return;
            }
            const { videoWidth, videoHeight } = camera;
            snapshot.width = videoWidth;
            snapshot.height = videoHeight;
            const context = snapshot.getContext('2d');
            context.drawImage(camera, 0, 0, videoWidth, videoHeight);
            snapshot.classList.remove('hidden');
            snapshot.toBlob(blob => {
                lastBlob = blob;
                lastCaptureSummary = {
                    capturedAt: new Date().toISOString(),
                    resolution: `${videoWidth}×${videoHeight}`,
                };
                enrollBtn.disabled = false;
                scanBtn.disabled = false;
                renderCaptureMeta(lastCaptureSummary);
                setStatus('Frame captured. Choose enroll or scan to process locally.', 'success');
                addLog('Frame captured', 'success');
            }, 'image/jpeg', 0.9);
        }

        function simulateDelay(ms = 400) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function ensureCapture() {
            if (!lastBlob) {
                setStatus('Capture a frame first.', 'error');
                throw new Error('No capture available');
            }
            return true;
        }

        enrollBtn.addEventListener('click', async () => {
            const studentId = studentIdInput.value.trim();
            if (!studentId) {
                setStatus('Enter a Student ID to enroll.', 'error');
                return;
            }
            try {
                await ensureCapture();
                setStatus('Saving enrollment locally…', 'info');
                await simulateDelay();
                localEnrollments.set(studentId, { ...lastCaptureSummary });
                persistEnrollments();
                setStatus(`Enrollment saved locally for ${studentId}.`, 'success');
                addLog(`Enrollment saved for ${studentId}`, 'success');
            } catch (error) {
                console.error(error);
                setStatus(error.message, 'error');
                addLog(error.message, 'error');
            }
        });

        scanBtn.addEventListener('click', async () => {
            try {
                await ensureCapture();
                const action = actionSelect.value;
                const enrolledIds = [...localEnrollments.keys()];
                const matchedId = studentIdInput.value.trim() || enrolledIds[enrolledIds.length - 1] || 'LOCAL-DEMO';

                setStatus('Processing scan locally…', 'info');
                await simulateDelay();

                const event = {
                    student: { student_id: matchedId },
                    action,
                    timestamp: new Date().toISOString(),
                };
                setStatus(`Scan recorded for ${event.student.student_id} (${event.action}).`, 'success');
                addLog(`Scan ${event.action} for ${event.student.student_id}`, 'success');
            } catch (error) {
                console.error(error);
                setStatus(error.message, 'error');
                addLog(error.message, 'error');
            }
        });

        clearLogBtn.addEventListener('click', () => {
            sessionLog.length = 0;
            logContainer.innerHTML = '';
        });

        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        captureBtn.addEventListener('click', captureFrame);
    </script>
</body>
</html>
